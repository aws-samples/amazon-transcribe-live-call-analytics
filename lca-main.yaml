# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License").
# You may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---
AWSTemplateFormatVersion: "2010-09-09"

Description: Amazon Transcribe Live Call Analytics - LCA (v0.2.1)

Parameters:

  InstallDemoAsteriskServer:
    Type: String
    Default: true
    AllowedValues:
      - true
      - false
    Description: >
      Set to true to automatically install a demo Asterisk server for testing
      Chime Voice Connector streaming.

  DemoSoftphoneAllowedCidr:
    Type: String
    AllowedPattern: "( *|([0-9]{1,3}.){3}[0-9]{1,3}(/([0-9]|[1-2][0-9]|3[0-2])))"
    Description: >
      Ignored if Install Demo Asterisk Server is false.
      CIDR block allowed by demo Asterisk server for soft phone registration.
      Example: '198.51.100.36/32'

  SiprecAllowedCidrList:
    Type: String
    # yamllint disable rule:line-length
    AllowedPattern: "( *|(([0-9]{1,3}.){3}[0-9]{1,3}(/([0-9]|[1-2][0-9]|3[0-2]))))(, *([0-9]{1,3}.){3}[0-9]{1,3}(/([0-9]|[1-2][0-9]|3[0-2])))*"
    # yamllint enable rule:line-length
    Description: >
      Ignored if Install Demo Asterisk Server is true.
      Comma delimited list of public CIDR blocks allowed by Chime Voice Connector for SIPREC source hosts. Mask of /27 to /32 is allowed.
      Example: '198.51.100.0/27, 203.0.113.128/27'

  S3BucketName:
    Type: String
    Description: >
      (Optional) Existing bucket where call recording files will be stored.
      Leave blank to automatically create new bucket.
    # yamllint disable rule:line-length
    AllowedPattern: '( *|(?=^.{3,63}$)(?!^(\d+\.)+\d+$)(^(([a-z0-9]|[a-z0-9][a-z0-9\-]*[a-z0-9])\.)*([a-z0-9]|[a-z0-9][a-z0-9\-]*[a-z0-9])$))'
    # yamllint enable rule:line-length

  AudioFilePrefix:
    Type: String
    Default: lca-audio-recordings/
    Description: The Amazon S3 prefix where the audio files will be saved (must end in "/")

  IsContentRedactionEnabled:
    Type: String
    Default: 'false'
    Description: >-
      Enable content redaction from Amazon Transcribe transcription output. This is only used when
      the 'en-US' language is selected in the TranscribeLanguageCode parameter.
    AllowedValues:
      - 'true'
      - 'false'

  TranscribeContentRedactionType:
    Type: String
    Default: PII
    Description: >-
      Type of content redaction from Amazon Transcribe transcription output
    AllowedValues:
      - PII

  TranscribeLanguageCode:
    Type: String
    Description: >-
      Language code to be used for Amazon Transcribe
    Default: en-US
    AllowedValues:
      - en-US
      - es-US
      - en-GB
      - fr-CA
      - fr-FR
      - en-AU
      - it-IT
      - de-DE
      - pt-BR
      - ja-JP
      - ko-KR
      - zh-CN

  TranscribePiiEntityTypes:
    Type: String
    Default: BANK_ACCOUNT_NUMBER,BANK_ROUTING,CREDIT_DEBIT_NUMBER,CREDIT_DEBIT_CVV,CREDIT_DEBIT_EXPIRY,PIN,EMAIL,ADDRESS,NAME,PHONE,SSN
    Description: >-
      Select the PII entity types you want to identify or redact. Remove the values that you don't want to redact from the default. DO NOT ADD CUSTOM VALUES HERE.

  CustomVocabularyName:
    Type: String
    Default: ''
    Description: >-
      The name of the vocabulary to use when processing the transcription job. Leave blank if no custom vocabulary to be used. If yes, the custom
      vocabulary must pre-exist in your account.

  IsSentimentAnalysisEnabled:
    Type: String
    Default: 'true'
    Description: >-
      Enable sentiment analysis using Amazon Comprehend
    AllowedValues:
      - 'true'
      - 'false'

  AdminEmail:
    Type: String
    Description: >-
      Email address of admin user (e.g. jdoe@example.com) used for the API and web UI.
      An initial temporary password will be automatically sent to this user via email.
    AllowedPattern: '^[\w.+-]+@([\w-]+\.)+[\w-]{2,6}$'

  AllowedSignUpEmailDomain:
    Type: String
    Default: ''
    Description: >-
      Email address domain (e.g. example.com) that is allowed to signin and signup using the web UI.
      If left empty, signup via the web UI is disabled and users will have to be created using
      Cognito.
    AllowedPattern: '^(|([\w-]+\.)+[\w-]{2,6})$'

  DemoAsteriskDownloadUrl:
    Type: String
    Default: https://downloads.asterisk.org/pub/telephony/asterisk/asterisk-16-current.tar.gz
    Description: URL for Asterisk source distribution tar file download - see https://www.asterisk.org/

  DemoAsteriskAgentAudioURL:
    Type: String
    Default: https://s3.<REGION_TOKEN>.amazonaws.com/<ARTIFACT_BUCKET_TOKEN>/<ARTIFACT_PREFIX_TOKEN>/lca-chimevc-stack/demo-audio/agent.wav
    Description: URL for audio (agent.wav) file download for demo Asterisk server.

  CloudFrontPriceClass:
    Type: String
    Default: PriceClass_100
    Description: >-
      Specify the CloudFront price class. See https://aws.amazon.com/cloudfront/pricing/ for a
      description of each price class.
    AllowedValues:
      - PriceClass_100
      - PriceClass_200
      - PriceClass_All
    ConstraintDescription: >-
      Allowed Price Classes PriceClass_100 PriceClass_200 and PriceClass_All

  CloudFrontAllowedGeos:
    Type: String
    Default: ''
    Description: >-
      Specify a comma separated list of two letter country codes (uppercase ISO 3166-1) that are
      allowed to access the web user interface via CloudFront. For example: US,CA. Leave empty if
      you do not want geo restrictions to be applied.
    AllowedPattern: '^(|[A-Z]{2}(,[A-Z]{2})*)$'
    ConstraintDescription: >-
      Comma separated list of uppercase two letter country codes or empty

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Telephony Ingestion Options
        Parameters:
          - InstallDemoAsteriskServer
          - DemoSoftphoneAllowedCidr
          - SiprecAllowedCidrList
      - Label:
          default: Web UI Authentication
        Parameters:
          - AdminEmail
          - AllowedSignUpEmailDomain
      - Label:
          default: Amazon S3 Configuration
        Parameters:
          - S3BucketName
          - AudioFilePrefix
      - Label:
          default: Amazon Transcribe Configuration
        Parameters:
          - IsContentRedactionEnabled
          - TranscribeLanguageCode
          - TranscribeContentRedactionType
          - TranscribePiiEntityTypes
          - CustomVocabularyName
      - Label:
          default: Amazon Comprehend Configuration
        Parameters:
          - IsSentimentAnalysisEnabled
      - Label:
          default: Download locations
        Parameters:
          - DemoAsteriskDownloadUrl
          - DemoAsteriskAgentAudioURL
      - Label:
          default: Amazon CloudFront Configuration
        Parameters:
          - CloudFrontPriceClass
          - CloudFrontAllowedGeos
    ParameterLabels:
      S3BucketName:
        default: Call Audio Recordings Bucket Name
      AudioFilePrefix:
        default: Audio File Prefix
      AdminEmail:
        default: Admin Email Address
      AllowedSignUpEmailDomain:
        default: Authorized Account Email Domain
      InstallDemoAsteriskServer:
        default: Install Demo Asterisk Server
      DemoSoftphoneAllowedCidr:
        default: Allowed CIDR Block for Demo Softphone
      SiprecAllowedCidrList:
        default: Allowed CIDR List for Siprec Integration
      IsContentRedactionEnabled:
        default: Enable Content Redaction for Transcripts
      TranscribeLanguageCode:
        default: Language for Transcription
      TranscribeContentRedactionType:
        default: Content Redaction Type for Transcription
      TranscribePiiEntityTypes:
        default: Transcription PII Redaction Entity Types
      CustomVocabularyName:
        default: Transcription Custom Vocabulary Name
      DemoAsteriskDownloadUrl:
        default: Demo Asterisk Server Source Code Download URL
      DemoAsteriskAgentAudioURL:
        default: Demo Asterisk Server Agent WAV File Download URL
      IsSentimentAnalysisEnabled:
        default: Enable Sentiment Analysis using Amazon Comprehend
      CloudFrontPriceClass:
        default: CloudFront Price Class
      CloudFrontAllowedGeos:
        default: CloudFront Allowed Geographies

Mappings:
  TranscribeToComprehendLanguage:
    en-US:
      Value: en
    es-US:
      Value: es

Resources:

  AISTACK:
    Type: AWS::CloudFormation::Stack
    Properties:
      # yamllint disable rule:line-length
      TemplateURL: https://s3.<REGION_TOKEN>.amazonaws.com/<ARTIFACT_BUCKET_TOKEN>/<ARTIFACT_PREFIX_TOKEN>/lca-ai-stack/<VERSION_TOKEN>/template.yaml
      # yamllint enable rule:line-length
      Parameters:
        S3BucketName: !Ref S3BucketName
        AudioFilePrefix: !Ref AudioFilePrefix
        AdminEmail: !Ref AdminEmail
        AllowedSignUpEmailDomain: !Ref AllowedSignUpEmailDomain
        IsContentRedactionEnabled: !Ref IsContentRedactionEnabled
        TranscribeContentRedactionType: !Ref TranscribeContentRedactionType
        TranscribeLanguageCode: !Ref TranscribeLanguageCode
        TranscribePiiEntityTypes: !Ref TranscribePiiEntityTypes
        CustomVocabularyName: !Ref CustomVocabularyName
        ComprehendLanguageCode:
          !FindInMap [TranscribeToComprehendLanguage, !Ref TranscribeLanguageCode, Value]
        IsSentimentAnalysisEnabled: !Ref IsSentimentAnalysisEnabled
        CloudFrontPriceClass: !Ref CloudFrontPriceClass
        CloudFrontAllowedGeos: !Ref CloudFrontAllowedGeos

  CHIMEVCSTACK:
    Type: AWS::CloudFormation::Stack
    Properties:
      # yamllint disable rule:line-length
      TemplateURL: https://s3.<REGION_TOKEN>.amazonaws.com/<ARTIFACT_BUCKET_TOKEN>/<ARTIFACT_PREFIX_TOKEN>/lca-chimevc-stack/template.yaml
      # yamllint enable rule:line-length
      Parameters:
        InstallDemoAsteriskServer: !Ref InstallDemoAsteriskServer
        DemoSoftphoneAllowedCidr: !Ref DemoSoftphoneAllowedCidr
        SiprecAllowedCidrList: !Ref SiprecAllowedCidrList
        DemoAsteriskDownloadUrl: !Ref DemoAsteriskDownloadUrl
        DemoAsteriskAgentAudioURL: !Ref DemoAsteriskAgentAudioURL

Outputs:

  CloudfrontEndpoint:
    Description: Endpoint for Cloudfront distribution
    Value: !GetAtt AISTACK.Outputs.CloudfrontEndpoint

  RecordingsS3Bucket:
    Description: Bucket contains all the call recordings
    Value: !GetAtt AISTACK.Outputs.S3BucketName

  DemoPBXIPAddress:
    Description: Demo Asterisk Server IP Address
    Value: !GetAtt CHIMEVCSTACK.Outputs.DemoPBXIPAddress

  DemoPBXPhoneNumber:
    Description: Demo Asterisk Server Phone Number
    Value: !GetAtt CHIMEVCSTACK.Outputs.DemoPBXPhoneNumber

  AsteriskInstanceId:
    Description: Demo Asterisk Server EC2 instanceId
    Value: !GetAtt CHIMEVCSTACK.Outputs.AsteriskInstanceId
